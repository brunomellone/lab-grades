---
title: "Mellone"
author: "Bruno Mellone"
format: 
  html: default
  pdf: default
execute:
  warning: false
  message: false
---

Link to GitHub repository: https://github.com/brunomellone/lab-grades

```{r}
library(here)
library(dplyr)
library(ggplot2)
library(tidyr)
library(vroom)
library(readr)
here :: i_am("lab-grades.Rproj")
```
# 1.1 Study organization
Question 1
```{r}
courses <- vroom(here("data","courses.csv"))
```
Question 2
```{r}
courses |>
  arrange(course) |>
  rename(
    `course name`    = course,
    identifier       = course_id,
    module           = module,
    `number of exams` = nb_grades
  ) |>
  knitr::kable()
```


# 1.2 Students

## Question 3
```{r}
students <- vroom(here("data","students.csv"))
cols(
  id = col_double(),
  group = col_double(),
  birth_date = col_date(format = ""),
  sex = col_character(),
  .delim = ","
)
```
```{r}
students <- vroom(
  here("data", "students.csv"),
  col_types = cols(
    id = col_double(),
    group = col_double(),
    birth_date = col_date(), 
    sex = col_factor()       
  )
)
```


# 1.3 Grades
## Question 4

```{r}
grades <- read_delim(here("data", "grades.csv"),
  delim = ";",
  na = "unknown")
```

# 2. Student population analysis

## Question 5

```{r}
students |>
  summarise(n = n(), .by = group) |>
  ggplot(aes(x = group, y = n)) +
  geom_col() +
  labs(x = "group", y = "number of students")
```
The number of students per group varies from around 40 and 75. 

## Question 6
```{r}
students |>
  summarise(n = n(), .by = c(group, sex)) |>
  ggplot(aes(x = group, y = n, fill = sex)) +
  geom_col(position = "fill") +
  labs(x = "group", y = "proportion of students", fill = "sex")

```
Overall, groups respect gender parity.

## Question 7

```{r}
library(lubridate)

students_new <- students |>
  mutate(
    birth_date = date(birth_date),
    age = time_length(today() - birth_date, unit = "year") |> round()
    )

students_new |>
  ggplot(aes(x = age)) +
  geom_histogram(binwidth =1) +
  labs(x = "age (years)", y = "number of students")
```
This graph shows that students are mostly around their 20s. 

```{r}
students_new |>
  summarise(median_age = median(age), .by = group) |>
  mutate(median_age = round(median_age))
```

```{r}
students_new |>
  slice_max(age, n = 1, by = group) |>
  select(id, sex, age) |>
  arrange(desc(age)) |>
  knitr::kable()
```

# 3. Simple grade analysis

## Question 10
```{r}
grades |>
  filter(!is.na(grade)) |>
  summarise(n_grades = n())
```

The data set contains `grades$n_grades`

## Question 11
```{r}
grades |>
  filter(!is.na(grade)) |>
  inner_join(courses, by = "course_id") |>
  filter(course == "Medicine and Healing Arts") |>
  inner_join(students, by = "id") |>
  summarise(mean_grade = mean(grade), .by = group) |>
  ggplot(aes(x = group, y = mean_grade)) +
  geom_col() +
  labs(x = "group", y = "average grade in Medicine and Healing Arts")
```
## Question 12

```{r}
grades |>
  filter(!is.na(grade)) |>
  inner_join(courses, by = "course_id") |>
  ggplot(aes(x = grade)) +
  geom_histogram(binwidth = 1) +
  facet_wrap(~ module) +
  labs(x = "grade", y = "number of grades")
```

## Question 14
The distribution of the grades in modules 1 and 2 seem to be normally distributed. Module 1's distribution is around the mean of 9 and module 2 has a higher mean of 12. 

However, the graph of module 3 can lead us to the conclusion that it was perhaps the easiest module as more than 3000 students had over 13 and grades were generally better, when compared to other models. 

We could therefore conclude that module 3 had a higher average grade. This could lead us to believe that it was either easier or that students studied harder for it. 


# 4. Attendance analysis

```{r}
grades_clean <- grades |>
  filter(!is.na(grade))

grades_per_student <- grades_clean |>
  summarise(n_grades = n(), .by = id) |>
  left_join(students, by = "id") |>
  select(id, group, sex, n_grades)

grades_per_student |>
  slice_head(n = 10)

grades_per_student |>
  summarise(
    min    = min(n_grades),
    max    = max(n_grades),
    mean   = mean(n_grades),
    median = median(n_grades)
  ) |>
  knitr::kable()
```

## Question 14

```{r}
grades_per_student |>
  ggplot(aes(x = sex, y = n_grades)) +
  geom_boxplot() +
  labs(x = "sex", y = "number of grades")
```
The medians are identical for both sex groups and also equal to their third quartile, on 56. The interquartile range is also similar in both groups, hence, we can conclude that the variability in the distribution of the number of grades is similar. However, the female group has more outliers than the male group. 

## Question 15
```{r}
grades_greek <- grades_clean |>
  inner_join(courses, by = "course_id") |>
  filter(course == "Greek Mythology and Folklore") |>
  summarise(n_grades = n(), .by = id) |>
  left_join(students, by = "id") |>
  select(id, group, n_grades)

grades_greek |>
  slice_head(n = 10)
```

## Question 16
```{r}
grades_greek |>
  summarise(n_students = n(), .by = n_grades) |>
  ggplot(aes(x = n_grades, y = n_students)) +
  geom_col() +
  labs(x = "number of grades in Greek Mythology and Folklore",
       y = "number of students")
```

## Question 17

```{r}
grades_greek |>
  mutate(group = factor(group)) |>
  ggplot(aes(x = n_grades)) +
  geom_histogram(binwidth = 1, boundary = 0.5) +
  facet_wrap(~ group) +
  labs(
    x = "number of grades in Greek Mythology and Folklore",
    y = "number of students"
  )
```
We notice that the number of grades per group seem relatively similar. However, group 7 is the lowest of them all.


## Question 18

Taking the analysis a step further: 

```{r}
grades_greek_sex <- grades_greek |>
  left_join(students |> select(id, sex), by = "id")

grades_greek_sex |>
  mutate(
    group = factor(group),
    sex   = factor(sex)
  ) |>
  ggplot(aes(x = n_grades, fill = sex, colour = sex)) +
  geom_histogram(binwidth = 1, boundary = 0.5) +
  facet_wrap(~ group) +
  labs(
    x = "number of grades in Greek Mythology and Folklore",
    y = "number of students",
    fill = "sex",
    colour = "sex"
  )
```
This new analysis shows us that on average, female students had more grades than male students. 

# 5. Grade analysis

## Question 19

```{r}
student_course_means_wide <- grades_clean |>
  inner_join(courses, by = "course_id") |>
  summarise(mean_grade = mean(grade), .by = c(id, course)) |>
  inner_join(students |> select(id, group), by = "id") |>
  select(id, group, course, mean_grade) |>
  pivot_wider(names_from = course, values_from = mean_grade)
```

```{r}
student_course_means_wide |>
  slice_head(n = 5)
```
## Question 20

```{r}
student_course_means_group <- student_course_means_wide |>
  summarise(
    mean_rhetoric = mean(`Rhetoric and Persuasion`, na.rm = TRUE),
    mean_music   = mean(`Music and Poetry`,       na.rm = TRUE),
    .by = group
  )

student_course_means_group |>
  ggplot(aes(x = mean_rhetoric, y = mean_music)) +
  geom_point() + 
  geom_text(aes(label = group), vjust = -0.5) +
  labs(
    x = "average grade in Rhetoric and Persuasion (per group)",
    y = "average grade in Music and Poetry (per group)"
  )
```
While some groups fall far behind a potential trend line (notably groups 12 and 9), the graph displays a potential positive relation between the average grade in Rhetoric and Persuasion and the average grade in mUsic and Poetry. 


## Question 21

```{r}
student_course_means_wide |>
  select(group,
         `Architecture and Sculpture`,
         `Combat and Martial Arts of the Gods`) |>
  drop_na() |>
  summarise(
    correlation = cor(`Architecture and Sculpture`,
                      `Combat and Martial Arts of the Gods`),
    .by = group
  )
```

## Question 22

```{r}
cor_by_group <- student_course_means_wide |>
  select(group,
         `Architecture and Sculpture`,
         `Combat and Martial Arts of the Gods`) |>
  drop_na() |>
  summarise(
    correlation = cor(`Architecture and Sculpture`,
                      `Combat and Martial Arts of the Gods`),
    .by = group
  )

best_group <- cor_by_group |>
  mutate(abs_cor = abs(correlation)) |>
  slice_max(abs_cor, n = 1) |>
  pull(group)

student_course_means_wide |>
  filter(group == best_group) |>
  ggplot(aes(x = `Combat and Martial Arts of the Gods`,
             y = `Architecture and Sculpture`)) +
  geom_point() +
  labs(
    x = "average grade in Combat and Martial Arts of the Gods",
    y = "average grade in Architecture and Sculpture"
  )
```

There seems to be a negative relation between the two. A higher average in Combat and Martial Arts of the Gods is related to a low average in Architecture and Sculpture. 

## Question 23

```{r}
final_grades <- student_course_means_wide |>
  left_join(students |> select(id, sex), by = "id") |>
  rowwise() |>
  mutate(
    final_grade = mean(c_across(-c(id, group, sex)), na.rm = TRUE)
  ) |>
  ungroup() |>
  select(id, group, sex, final_grade) |>
  arrange(desc(final_grade))

final_grades |>
  slice_head(n = 5) |>
  knitr::kable()
```

## Question 24 

```{r}
student_course_means_long <- grades_clean |>
  inner_join(courses, by = "course_id") |>
  inner_join(students |> select(id, group, sex), by = "id") |>
  summarise(mean_grade = mean(grade),
            .by = c(id, group, sex, course, module))

final_grades <- student_course_means_long |>
  summarise(final_grade = mean(mean_grade),
            .by = c(id, group, sex))

final_grades |>
  mutate(group = factor(group)) |>
  ggplot(aes(x = group, y = final_grade)) +
  geom_boxplot() +
  labs(x = "group", y = "final grade")
```
This graph shows the different grade distributions per group. The median (represented by the thick black line) is different from one group to the other. This displays the differences in the final grade between each group. 

Groups 6 and 7 have the highest medians of all groups and also highest third and first quartiles.

## Question 25

```{r}
final_grades |>
  mutate(group = factor(group),
         sex   = factor(sex)) |>
  ggplot(aes(x = group, y = final_grade)) +
  geom_boxplot() +
  facet_wrap(~ sex) +
  labs(x = "group", y = "final grade")
```
By including sex in our analysis, we could have expected a bigger change in the distribution of the final grades between the groups. However, this was not really the case as variability (represented by the interquartile difference) is similar in each group for each sex. 

Question 26

```{r}
course_condition <- student_course_means_long |>
  summarise(min_course = min(mean_grade), .by = id) |>
  mutate(pass_course = min_course >= 5) |>
  select(id, pass_course)

module_condition <- student_course_means_long |>
  summarise(module_avg = mean(mean_grade), .by = c(id, module)) |>
  summarise(min_module = min(module_avg), .by = id) |>
  mutate(pass_module = min_module >= 10) |>
  select(id, pass_module)

pass_info <- course_condition |>
  inner_join(module_condition, by = "id") |>
  mutate(pass = pass_course & pass_module) |>
  select(id, pass)

final_pass <- final_grades |>
  left_join(pass_info, by = "id") |>
  select(id, group, final_grade, pass)
```

Question 27
```{r}
final_pass |>
  filter(!pass, final_grade >= 10) |>
  summarise(n_students = n())
```

Question 28
```{r}
final_pass |>
  summarise(pass_rate = mean(pass), .by = group) |>
  ggplot(aes(x = factor(group), y = pass_rate)) +
  geom_col() +
  labs(x = "group", y = "pass rate")
```
We notice that the passing rate is highest in group 7, around 0.55. If we compare this to previous results, group 7 was the one who had the least number of grades and this can have an effect on the passing grade. This result is sort of expected as the group had the second highest median, bigger than 11. 

Group 6's pass rate is also quite high compared to other groups (close to 0.4). This results is also expected as this group had the highest median.

This is quite different from other groups as most do not manage to have a pass rate larger than 10%. 

Question 29
```{r}
student_course_means_long |>
  filter(mean_grade < 5) |>
  summarise(n_students = n_distinct(id), .by = course) |>
  slice_max(n_students, n = 1)
```
The course that is most responsible for failure is "Combat and Martial Arts of the Gods". 

Question 30
```{r}
final_pass |>
  left_join(students, by = "id") |>
  mutate(
    birth_date = ymd(birth_date),
    age = time_length(today() - birth_date, unit = "year") |> round()
  ) |>
  summarise(success_rate = mean(pass), .by = age) |>
  ggplot(aes(x = age, y = success_rate)) +
  geom_point() +
  labs(x = "age", y = "success rate")
```
There does not seem to be a clear effect of age on the success rate, even though the students with highest success rate being aged more than 30 years old. 





